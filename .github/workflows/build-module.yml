name: ğŸ“¦ Build Magisk Module

on:
  push:
    branches: [ main, master ]
    paths:
      - 'box/**'
      - 'webroot/**'
      - 'customize.sh'
      - 'module.prop'
      - '*.sh'
  pull_request:
    branches: [ main, master ]
    types: [ closed ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'åˆ›å»ºæ–°ç‰ˆæœ¬å‘å¸ƒ'
        required: false
        default: false
        type: boolean
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: false
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-module:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y zip unzip jq curl
        
        # å®‰è£…GitHub CLI (ç”¨äºåˆ›å»ºå‘å¸ƒ)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y gh

    - name: ğŸ”¢ è®¡ç®—ç‰ˆæœ¬å·
      id: version
      run: |
        current_version=$(grep -o 'version=v[0-9.]*' module.prop | cut -d'=' -f2 | sed 's/v//')
        current_code=$(grep -o 'versionCode=[0-9]*' module.prop | cut -d'=' -f2)
        
        echo "current_version=$current_version" >> $GITHUB_OUTPUT
        echo "current_code=$current_code" >> $GITHUB_OUTPUT
        
        # æ ¹æ®è§¦å‘ç±»å‹è®¡ç®—æ–°ç‰ˆæœ¬
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.create_release }}" = "true" ]; then
          # æ‰‹åŠ¨åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
          version_type="${{ github.event.inputs.version_type }}"
          
          IFS='.' read -ra VERSION_PARTS <<< "$current_version"
          major=${VERSION_PARTS[0]}
          minor=${VERSION_PARTS[1]:-0}
          patch=${VERSION_PARTS[2]:-0}
          
          case $version_type in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          new_version="$major.$minor.$patch"
          new_code=$(date +"%Y%m%d")
          is_release=true
        else
          # å¼€å‘ç‰ˆæœ¬ï¼Œä½¿ç”¨å½“å‰ç‰ˆæœ¬ + æ„å»ºå·
          build_number=$(printf "%04d" ${{ github.run_number }})
          new_version="$current_version-dev.$build_number"
          new_code=$(date +"%Y%m%d%H")
          is_release=false
        fi
        
        echo "new_version=$new_version" >> $GITHUB_OUTPUT
        echo "new_code=$new_code" >> $GITHUB_OUTPUT
        echo "is_release=$is_release" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: v$current_version ($current_code)"
        echo "ğŸ“¦ æ–°ç‰ˆæœ¬: v$new_version ($new_code)"
        echo "ğŸ“¦ æ˜¯å¦å‘å¸ƒ: $is_release"

    - name: ğŸ“ æ›´æ–°æ¨¡å—ä¿¡æ¯
      run: |
        new_version="${{ steps.version.outputs.new_version }}"
        new_code="${{ steps.version.outputs.new_code }}"
        
        # æ›´æ–°module.prop
        sed -i "s/version=v.*/version=v$new_version/" module.prop
        sed -i "s/versionCode=.*/versionCode=$new_code/" module.prop
        
        # æ›´æ–°æè¿°ä¸­çš„æ—¶é—´æˆ³
        current_time=$(date +"%Y-%m-%d %H:%M UTC")
        sed -i "s/description=.*/description=sing-box tunnel proxy for Android - Built on $current_time/" module.prop
        
        # æ›´æ–°update.json
        if [ "${{ steps.version.outputs.is_release }}" = "true" ]; then
          # å‘å¸ƒç‰ˆæœ¬
          zip_url="https://github.com/${{ github.repository }}/releases/download/v$new_version/box_for_root-v$new_version.zip"
        else
          # å¼€å‘ç‰ˆæœ¬
          zip_url="https://github.com/${{ github.repository }}/releases/download/dev-v$new_version/box_for_root-v$new_version.zip"
        fi
        
        jq --arg version "v$new_version" \
           --arg versionCode "$new_code" \
           --arg zipUrl "$zip_url" \
           '.version = $version | .versionCode = $versionCode | .zipUrl = $zipUrl' \
           update.json > update.json.tmp && mv update.json.tmp update.json
        
        echo "âœ… æ¨¡å—ä¿¡æ¯å·²æ›´æ–°"
        echo "ğŸ“‹ æ–°module.propå†…å®¹:"
        cat module.prop
        echo "ğŸ“‹ æ–°update.jsonå†…å®¹:"
        cat update.json

    - name: ğŸ” éªŒè¯æ¨¡å—å®Œæ•´æ€§
      run: |
        echo "ğŸ” éªŒè¯æ¨¡å—ç»“æ„..."
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        required_files=(
          "module.prop"
          "customize.sh" 
          "uninstall.sh"
          "META-INF/com/google/android/update-binary"
          "META-INF/com/google/android/updater-script"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          else
            echo "âœ… $file"
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        fi
        
        # æ£€æŸ¥boxç›®å½•ç»“æ„
        if [ ! -d "box" ]; then
          echo "âŒ boxç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥sing-boxé…ç½®
        if [ ! -f "box/sing-box/config.json" ]; then
          echo "âŒ sing-boxé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # éªŒè¯JSONé…ç½®æ–‡ä»¶
        if ! jq empty box/sing-box/config.json; then
          echo "âŒ sing-boxé…ç½®æ–‡ä»¶JSONæ ¼å¼æ— æ•ˆ"
          exit 1
        fi
        
        if [ -f "box/zashboard/config.json" ] && ! jq empty box/zashboard/config.json; then
          echo "âŒ zashboardé…ç½®æ–‡ä»¶JSONæ ¼å¼æ— æ•ˆ"
          exit 1
        fi
        
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æƒé™å’Œè¯­æ³•
        script_files=("customize.sh" "uninstall.sh" "box_service.sh")
        for script in "${script_files[@]}"; do
          if [ -f "$script" ]; then
            if ! bash -n "$script"; then
              echo "âŒ $script è¯­æ³•é”™è¯¯"
              exit 1
            else
              echo "âœ… $script è¯­æ³•æ­£ç¡®"
            fi
          fi
        done
        
        echo "âœ… æ¨¡å—å®Œæ•´æ€§éªŒè¯é€šè¿‡"

    - name: ğŸ“¦ æ„å»ºæ¨¡å—å‹ç¼©åŒ…
      run: |
        new_version="${{ steps.version.outputs.new_version }}"
        
        echo "ğŸ“¦ å¼€å§‹æ„å»ºæ¨¡å—..."
        
        # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
        find . -name ".DS_Store" -delete
        find . -name "Thumbs.db" -delete
        find . -name "*.tmp" -delete
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build
        
        # æ’é™¤çš„æ–‡ä»¶å’Œç›®å½•
        exclude_patterns=(
          ".git/*"
          ".github/*" 
          "docs/*"
          "build/*"
          "*.md"
          "update.json"
          "test_*.sh"
          "*.log"
          ".gitignore"
          ".gitattributes"
        )
        
        # æ„å»ºzipå‘½ä»¤çš„æ’é™¤å‚æ•°
        exclude_args=""
        for pattern in "${exclude_patterns[@]}"; do
          exclude_args="$exclude_args -x '$pattern'"
        done
        
        # åˆ›å»ºå‹ç¼©åŒ…
        zip_name="box_for_root-v$new_version.zip"
        eval "zip -r -9 -q \"build/$zip_name\" . $exclude_args"
        
        # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        cd build
        sha256sum "$zip_name" > "$zip_name.sha256"
        md5sum "$zip_name" > "$zip_name.md5"
        
        file_size=$(stat -c%s "$zip_name")
        file_size_mb=$(echo "scale=2; $file_size / 1024 / 1024" | bc)
        
        echo "âœ… æ¨¡å—æ„å»ºå®Œæˆ"
        echo "ğŸ“¦ æ–‡ä»¶å: $zip_name"
        echo "ğŸ“¦ æ–‡ä»¶å¤§å°: ${file_size_mb}MB"
        echo "ğŸ“¦ SHA256: $(cat $zip_name.sha256 | cut -d' ' -f1)"
        
        # è¾“å‡ºæ„å»ºä¿¡æ¯
        echo "zip_name=$zip_name" >> $GITHUB_ENV
        echo "file_size=$file_size" >> $GITHUB_ENV
        echo "file_size_mb=$file_size_mb" >> $GITHUB_ENV

    - name: ğŸ“‹ ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        new_version="${{ steps.version.outputs.new_version }}"
        current_time=$(date +"%Y-%m-%d %H:%M:%S UTC")
        
        # è·å–è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„æäº¤
        if [ "${{ steps.version.outputs.is_release }}" = "true" ]; then
          # å°è¯•è·å–ä¸Šä¸€ä¸ªtag
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$last_tag" ]; then
            commits=$(git log --pretty=format:"- %s" "$last_tag"..HEAD)
          else
            commits=$(git log --pretty=format:"- %s" -10)
          fi
        else
          # å¼€å‘ç‰ˆæœ¬ï¼Œè·å–æœ€è¿‘çš„æäº¤
          commits=$(git log --pretty=format:"- %s" -5)
        fi
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        {
          echo "## ğŸ‰ sing-boxä¸“ç”¨Magiskæ¨¡å—"
          echo ""
          echo "### ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯"
          echo "- ç‰ˆæœ¬: v$new_version"
          echo "- æ„å»ºæ—¶é—´: $current_time"
          echo "- æ–‡ä»¶å¤§å°: ${{ env.file_size_mb }}MB"
          echo "- æ”¯æŒæ¶æ„: amd64, arm64, armv7"
          echo ""
          echo "### ğŸš€ ä¸»è¦ç‰¹æ€§"
          echo "- ä¸“ä¸ºsing-boxä¼˜åŒ–çš„Magiskæ¨¡å—"
          echo "- é›†æˆZashboard Webç®¡ç†ç•Œé¢"
          echo "- å¤šç§ç½‘ç»œæ¨¡å¼æ”¯æŒ (tproxy, redirect, tun, enhance)"
          echo "- æ™ºèƒ½åˆ†æµå’Œè§„åˆ™ç®¡ç†"
          echo "- æ€§èƒ½ä¼˜åŒ–çš„cgroupé…ç½®"
          echo "- å®Œæ•´çš„åº”ç”¨ä»£ç†æ§åˆ¶"
          echo ""
          echo "### ğŸ“‹ æ›´æ–°å†…å®¹"
          echo "$commits"
          echo ""
          echo "### ğŸ“¥ å®‰è£…æ–¹æ³•"
          echo "1. ä¸‹è½½ box_for_root-v$new_version.zip"
          echo "2. åœ¨Magisk Managerä¸­é€‰æ‹©å¹¶å®‰è£…æ¨¡å—"
          echo "3. é‡å¯è®¾å¤‡"
          echo "4. é…ç½®sing-boxå’Œå¯åŠ¨æœåŠ¡"
          echo ""
          echo "### ğŸ”§ é…ç½®æ–‡ä»¶"
          echo "- sing-boxé…ç½®: /data/adb/box/sing-box/config.json"
          echo "- æ¨¡å—è®¾ç½®: /data/adb/box/settings.ini"
          echo "- Webç•Œé¢: http://127.0.0.1:9090"
          echo ""
          echo "### ğŸ“‹ éªŒè¯ä¿¡æ¯"
          echo "- SHA256: $(cat build/${{ env.zip_name }}.sha256 | cut -d' ' -f1)"
          echo "- MD5: $(cat build/${{ env.zip_name }}.md5 | cut -d' ' -f1)"
          echo ""
          echo "---"
          echo "*æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨æ„å»º*"
        } > release_notes.md
        
        echo "âœ… æ›´æ–°æ—¥å¿—å·²ç”Ÿæˆ"

    - name: ğŸš€ åˆ›å»ºGitHub Release
      if: steps.version.outputs.is_release == 'true'
      run: |
        new_version="${{ steps.version.outputs.new_version }}"
        
        # åˆ›å»ºå‘å¸ƒ
        gh release create "v$new_version" \
          --title "ğŸ‰ Box for Magisk v$new_version" \
          --notes-file release_notes.md \
          build/${{ env.zip_name }} \
          build/${{ env.zip_name }}.sha256 \
          build/${{ env.zip_name }}.md5
        
        echo "âœ… GitHub Releaseå·²åˆ›å»º: v$new_version"

    - name: ğŸ“¤ ä¸Šä¼ å¼€å‘ç‰ˆæœ¬
      if: steps.version.outputs.is_release == 'false'
      run: |
        new_version="${{ steps.version.outputs.new_version }}"
        
        # åˆ›å»ºæˆ–æ›´æ–°å¼€å‘ç‰ˆæœ¬æ ‡ç­¾
        git tag -f "dev-v$new_version"
        git push origin "dev-v$new_version" --force
        
        # åˆ é™¤ç°æœ‰çš„å¼€å‘ç‰ˆæœ¬å‘å¸ƒ(å¦‚æœå­˜åœ¨)
        gh release delete "dev-v$new_version" --yes || true
        
        # åˆ›å»ºæ–°çš„å¼€å‘ç‰ˆæœ¬å‘å¸ƒ
        gh release create "dev-v$new_version" \
          --title "ğŸ”§ å¼€å‘ç‰ˆæœ¬ v$new_version" \
          --notes-file release_notes.md \
          --prerelease \
          build/${{ env.zip_name }} \
          build/${{ env.zip_name }}.sha256 \
          build/${{ env.zip_name }}.md5
        
        echo "âœ… å¼€å‘ç‰ˆæœ¬å·²ä¸Šä¼ : dev-v$new_version"

    - name: ğŸ“Š è¾“å‡ºæ„å»ºç»“æœ
      run: |
        new_version="${{ steps.version.outputs.new_version }}"
        is_release="${{ steps.version.outputs.is_release }}"
        
        echo "## ğŸ‰ æ¨¡å—æ„å»ºå®Œæˆ!"
        echo "**ç‰ˆæœ¬**: v$new_version"
        echo "**ç±»å‹**: $([ "$is_release" = "true" ] && echo "æ­£å¼å‘å¸ƒ" || echo "å¼€å‘ç‰ˆæœ¬")"
        echo "**æ–‡ä»¶**: ${{ env.zip_name }}"
        echo "**å¤§å°**: ${{ env.file_size_mb }}MB"
        echo "**æ„å»ºæ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")"
        echo ""
        echo "### ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:"
        if [ "$is_release" = "true" ]; then
          echo "1. æ£€æŸ¥GitHub Releaseé¡µé¢"
          echo "2. æµ‹è¯•æ¨¡å—å®‰è£…å’ŒåŠŸèƒ½"
          echo "3. æ›´æ–°æ–‡æ¡£å’Œè¯´æ˜"
        else
          echo "1. æŸ¥çœ‹å¼€å‘ç‰ˆæœ¬æ„å»ºç»“æœ"  
          echo "2. è¿›è¡ŒåŠŸèƒ½æµ‹è¯•"
          echo "3. å‡†å¤‡æ­£å¼å‘å¸ƒ"
        fi

  notify-failure:
    needs: build-module
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¢ å‘é€æ„å»ºå¤±è´¥é€šçŸ¥
      run: |
        echo "âŒ æ¨¡å—æ„å»ºå¤±è´¥"
        echo "**æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")"
        echo "**å·¥ä½œæµ**: ${{ github.workflow }}"
        echo "**è¿è¡ŒID**: ${{ github.run_id }}"
        echo "**è§¦å‘äº‹ä»¶**: ${{ github.event_name }}"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚é‚®ä»¶ã€Slackç­‰