# ===================================================================================
# å·¥ä½œæµåç§°: æž„å»ºä¸ŽæŽ¨é€
# ===================================================================================
name: "ðŸ“¦ æž„å»ºå¹¶æŽ¨é€æ¨¡å—åŒ…"

# ===================================================================================
# è§¦å‘æ¡ä»¶:
# 1. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
# 2. å½“ simple åˆ†æ”¯æœ‰ä»£ç æŽ¨é€æ—¶è§¦å‘ï¼Œä½†ä»…é™äºŽç‰¹å®šæ–‡ä»¶æˆ–ç›®å½•å‘ç”Ÿå˜åŒ–æ—¶
#    - è¿™æ¶µç›–äº†â€œupstreamæœ‰æ›´æ–°â€å’Œâ€œsing-boxæ ¸å¿ƒæœ‰æŽ¨é€æ›´æ–°â€ä¸¤ç§æƒ…å†µ
# ===================================================================================
on:
  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

  # å½“æœ‰ä»£ç æŽ¨é€åˆ° simple åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - simple
    paths:
      # åªæœ‰å½“ä»¥ä¸‹æ ¸å¿ƒæ–‡ä»¶æˆ–ç›®å½•å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰è§¦å‘å·¥ä½œæµ
      # è¿™æ ·å¯ä»¥é¿å…ä¿®æ”¹ README.md ç­‰éžåŠŸèƒ½æ€§æ–‡ä»¶æ—¶ä¹Ÿè§¦å‘æž„å»º
      - 'box/bin/sing-box'      # sing-box æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
      - 'box/sing-box/**'       # sing-box é…ç½®æ–‡ä»¶ç›®å½•
      - 'box/scripts/**'        # è‡ªå®šä¹‰è„šæœ¬ç›®å½•
      - 'box_service.sh'        # æ¨¡å—ä¸»æœåŠ¡è„šæœ¬
      - 'customize.sh'          # Magisk å®‰è£…è„šæœ¬
      - 'module.prop'           # æ¨¡å—ä¿¡æ¯æ–‡ä»¶

# ===================================================================================
# ä»»åŠ¡ (Jobs)
# ===================================================================================
jobs:
  # å®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„ä»»åŠ¡ï¼Œè´Ÿè´£æ‰€æœ‰äº‹æƒ…
  build-and-release:
    # ä»»åŠ¡çš„æ˜¾ç¤ºåç§°
    name: "ðŸ—ï¸ æž„å»ºå¹¶å‘å¸ƒæ¨¡å—"
    # è¿è¡Œæ­¤ä»»åŠ¡æ‰€éœ€çš„è™šæ‹ŸæœºçŽ¯å¢ƒ
    runs-on: ubuntu-latest
    # ä¸ºæ­¤ä»»åŠ¡æŽˆäºˆå†™æƒé™ï¼Œä»¥ä¾¿å®ƒå¯ä»¥åˆ›å»º GitHub Release
    permissions:
      contents: write

    # ä»»åŠ¡çš„æ‰§è¡Œæ­¥éª¤
    steps:
      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # -----------------------------------------------------------------------------
      - name: "ðŸšš ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ä»£ç ä»“åº“"
        uses: actions/checkout@v4
        with:
          # æ‹‰å–æ‰€æœ‰ git åŽ†å²è®°å½•ï¼Œè¿™å¯¹äºŽåŽç»­èŽ·å– commit hash æ˜¯å¿…éœ€çš„
          fetch-depth: 0

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 2: å‡†å¤‡çŽ¯å¢ƒå’Œç‰ˆæœ¬ä¿¡æ¯
      # -----------------------------------------------------------------------------
      - name: "âš™ï¸ ç¬¬äºŒæ­¥ï¼šç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯"
        id: versioning # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ªIDï¼Œæ–¹ä¾¿åŽç»­å¼•ç”¨å®ƒçš„è¾“å‡º
        run: |
          # æ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼šèµ‹äºˆ sing-box äºŒè¿›åˆ¶æ–‡ä»¶æ‰§è¡Œæƒé™ï¼Œå¦åˆ™æ— æ³•è¿è¡Œ
          echo "ðŸ”‘ èµ‹äºˆ sing-box æ‰§è¡Œæƒé™..."
          chmod +x box/bin/sing-box

          # æ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼šç›´æŽ¥æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ä»¥èŽ·å–å…¶å†…éƒ¨ç‰ˆæœ¬å·
          echo "â„¹ï¸ èŽ·å– sing-box æ ¸å¿ƒç‰ˆæœ¬..."
          # æ‰§è¡Œ version å‘½ä»¤ï¼Œå¹¶ä½¿ç”¨ awk æå–ç‰ˆæœ¬å·å­—ç¬¦ä¸² (ä¾‹å¦‚ "1.9.0-beta.5")
          CORE_VERSION=$(./box/bin/sing-box version | awk '{print $3}')
          
          # èŽ·å–å½“å‰ Git æäº¤çš„çŸ­å“ˆå¸Œå€¼ (å‰7ä½)
          echo "â„¹ï¸ èŽ·å– Git Commit Hash..."
          GIT_HASH=$(git rev-parse --short HEAD)

          # ç»„åˆæˆæœ€ç»ˆçš„æ¨¡å—ç‰ˆæœ¬å·ï¼Œæ ¼å¼ä¸ºï¼š[æ ¸å¿ƒç‰ˆæœ¬]+[commitå“ˆå¸Œ]
          FINAL_VERSION="${CORE_VERSION}+${GIT_HASH}"
          echo "âœ… æˆåŠŸç”Ÿæˆç‰ˆæœ¬å·: ${FINAL_VERSION}"

          # å°†ç‰ˆæœ¬å·å’Œæ‰“åŒ…æ–‡ä»¶åè®¾ç½®ä¸ºçŽ¯å¢ƒå˜é‡ï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION=${FINAL_VERSION}" >> $GITHUB_ENV
          echo "FILE_NAME=Box_for_Magisk-simple-${FINAL_VERSION}.zip" >> $GITHUB_ENV
          
          # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºæ­¤æ­¥éª¤çš„è¾“å‡ºï¼Œä¾› release æ­¥éª¤ä½¿ç”¨
          echo "TAG=${FINAL_VERSION}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 3: æ›´æ–°æ¨¡å—ä¿¡æ¯æ–‡ä»¶
      # -----------------------------------------------------------------------------
      - name: "ðŸ“ ç¬¬ä¸‰æ­¥ï¼šæ›´æ–° module.prop æ–‡ä»¶"
        run: |
          echo "âœï¸ å°†ç‰ˆæœ¬å·å†™å…¥ module.prop..."
          # ä½¿ç”¨ sed å‘½ä»¤å°† module.prop æ–‡ä»¶ä¸­çš„ version=xxxx è¿™ä¸€è¡Œç²¾ç¡®æ›¿æ¢ä¸ºæˆ‘ä»¬æ–°ç”Ÿæˆçš„ç‰ˆæœ¬å·
          sed -i "s/^version=.*/version=${{ env.VERSION }}/" module.prop
          echo "âœ… module.prop æ›´æ–°å®Œæ¯•ï¼"
          cat module.prop # æ‰“å°å‡ºæ¥æ£€æŸ¥ä¸€ä¸‹

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 4: åº”ç”¨é»˜è®¤é…ç½®ä¿®æ”¹
      # -----------------------------------------------------------------------------
      - name: "âš™ï¸ ç¬¬å››æ­¥ï¼šåº”ç”¨é»˜è®¤é…ç½®ä¿®æ”¹"
        run: |
          echo "ðŸ”§ å¼€å§‹åº”ç”¨é»˜è®¤é…ç½®..."

          # 1. è®¾ç½®é»˜è®¤ç½‘ç»œæ¨¡å¼ä¸º enhanceï¼ˆå¢žå¼ºæ¨¡å¼ï¼‰
          echo "ðŸ“¡ è®¾ç½®é»˜è®¤ç½‘ç»œæ¨¡å¼ä¸º enhance..."
          if [ -f "box/settings.ini" ]; then
            sed -i 's/^network_mode=.*/network_mode="enhance"/' box/settings.ini
            echo "âœ… ç½‘ç»œæ¨¡å¼å·²è®¾ç½®ä¸º enhance"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° box/settings.ini æ–‡ä»¶"
          fi

          # 2. è®¾ç½®é»˜è®¤ä»£ç†æ ¸å¿ƒä¸º sing-box
          echo "ðŸŽ¯ è®¾ç½®é»˜è®¤ä»£ç†æ ¸å¿ƒä¸º sing-box..."
          if [ -f "box/settings.ini" ]; then
            sed -i 's/^bin_name=.*/bin_name="sing-box"/' box/settings.ini
            echo "âœ… ä»£ç†æ ¸å¿ƒå·²è®¾ç½®ä¸º sing-box"
          fi

          # 3. è®¾ç½®é»˜è®¤é€æ˜Žä»£ç†è§„åˆ™ä¸ºé»‘åå•æ¨¡å¼
          echo "ðŸš« è®¾ç½®é»˜è®¤é€æ˜Žä»£ç†è§„åˆ™ä¸ºé»‘åå•æ¨¡å¼..."
          if [ -f "box/package.list.cfg" ]; then
            sed -i 's/^mode:.*/mode:blacklist/' box/package.list.cfg
            echo "âœ… é€æ˜Žä»£ç†è§„åˆ™å·²è®¾ç½®ä¸ºé»‘åå•æ¨¡å¼"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° box/package.list.cfg æ–‡ä»¶"
          fi

          # 4. ä¸‹è½½å¹¶é›†æˆ zashboard UI æ›¿ä»£é»˜è®¤ yacd
          echo "ðŸŽ¨ ä¸‹è½½å¹¶é›†æˆ zashboard UI..."
          ZASHBOARD_URL="https://github.com/Zephyruso/zashboard/archive/refs/heads/gh-pages.zip"
          UI_DIR="box/sing-box/dashboard"

          # åˆ›å»º UI ç›®å½•
          mkdir -p "$UI_DIR"

          # ä¸‹è½½ zashboard
          echo "ðŸ“¥ æ­£åœ¨ä¸‹è½½ zashboard..."
          curl -L -o zashboard.zip "$ZASHBOARD_URL"

          # è§£åŽ‹å¹¶å®‰è£…
          if [ -f "zashboard.zip" ]; then
            echo "ðŸ“‚ æ­£åœ¨è§£åŽ‹ zashboard..."
            unzip -q zashboard.zip

            # æŸ¥æ‰¾è§£åŽ‹åŽçš„ç›®å½•
            ZASHBOARD_DIR=$(find . -name "zashboard-gh-pages" -type d | head -1)

            if [ -d "$ZASHBOARD_DIR" ]; then
              echo "ðŸ“‹ æ­£åœ¨å®‰è£… zashboard åˆ° $UI_DIR..."
              cp -r "$ZASHBOARD_DIR"/* "$UI_DIR/"
              echo "âœ… zashboard UI å®‰è£…å®Œæˆ"

              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -rf zashboard.zip "$ZASHBOARD_DIR"
            else
              echo "âŒ æœªæ‰¾åˆ° zashboard è§£åŽ‹ç›®å½•"
            fi
          else
            echo "âŒ zashboard ä¸‹è½½å¤±è´¥"
          fi

          # 5. æ˜¾ç¤ºé…ç½®æ‘˜è¦
          echo ""
          echo "ðŸ“‹ é…ç½®æ‘˜è¦ï¼š"
          echo "  ðŸŽ¯ ä»£ç†æ ¸å¿ƒ: sing-box"
          echo "  ðŸ“¡ ç½‘ç»œæ¨¡å¼: enhance (å¢žå¼ºæ¨¡å¼)"
          echo "  ðŸš« ä»£ç†è§„åˆ™: blacklist (é»‘åå•æ¨¡å¼)"
          echo "  ðŸŽ¨ UI ç•Œé¢: zashboard"
          echo "âœ… é»˜è®¤é…ç½®åº”ç”¨å®Œæˆï¼"

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 5: ä»£ç è´¨é‡æ£€æŸ¥ (ä¼˜åŒ–ç‚¹)
      # -----------------------------------------------------------------------------
      - name: "ðŸ§ ç¬¬äº”æ­¥ï¼šæ£€æŸ¥è„šæœ¬è¯­æ³• (Shellcheck)"
        run: |
          echo "ðŸ›¡ï¸ å¼€å§‹æ£€æŸ¥ Shell è„šæœ¬è¯­æ³•..."
          shellcheck box_service.sh customize.sh
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼"

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 6: æ‰“åŒ…æ¨¡å—æ–‡ä»¶
      # -----------------------------------------------------------------------------
      - name: "ðŸ“¦ ç¬¬å…­æ­¥ï¼šæ‰“åŒ…æ¨¡å—ä¸º ZIP æ–‡ä»¶"
        run: |
          echo "âš™ï¸ å¼€å§‹æ‰“åŒ…..."
          # ä½¿ç”¨ zip å‘½ä»¤æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶
          # -r è¡¨ç¤ºé€’å½’æ‰“åŒ…å­ç›®å½•, -9 è¡¨ç¤ºæœ€é«˜åŽ‹ç¼©çŽ‡, -q è¡¨ç¤ºé™é»˜æ¨¡å¼
          zip -r9q ${{ env.FILE_NAME }} . -x ".git/*" ".github/*" "README.md"
          echo "âœ… æ‰“åŒ…å®Œæˆ: ${{ env.FILE_NAME }}"

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 7: åˆ›å»º GitHub Release
      # -----------------------------------------------------------------------------
      - name: "ðŸš€ ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»º GitHub é¢„å‘å¸ƒç‰ˆæœ¬"
        uses: softprops/action-gh-release@v1
        with:
          # è¦ä¸Šä¼ çš„é™„ä»¶æ–‡ä»¶ï¼Œå³æˆ‘ä»¬æ‰“åŒ…å¥½çš„ zip åŒ…
          files: ${{ env.FILE_NAME }}
          # Release çš„æ ‡ç­¾åï¼Œä½¿ç”¨æˆ‘ä»¬ç”Ÿæˆçš„å”¯ä¸€ç‰ˆæœ¬å·
          tag_name: ${{ steps.versioning.outputs.TAG }}
          # Release çš„æ ‡é¢˜
          name: "æ»šåŠ¨æ›´æ–° ${{ steps.versioning.outputs.TAG }}"
          # Release çš„æ­£æ–‡å†…å®¹ï¼Œä½¿ç”¨ Markdown æ ¼å¼
          body: |
            è‡ªåŠ¨æž„å»ºäºŽ `simple` åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚
            - **sing-box æ ¸å¿ƒç‰ˆæœ¬:** `${{ env.VERSION }}`
            - **æž„å»ºæ—¶é—´:** `$(date -u)`
            - **æäº¤å“ˆå¸Œ:** `${{ github.sha }}`
          # å°†æ­¤ Release æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œé€‚åˆæ»šåŠ¨æ›´æ–°
          prerelease: true

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 8: æŽ¨é€åˆ° Telegram Bot
      # -----------------------------------------------------------------------------
      - name: "ðŸ“± ç¬¬å…«æ­¥ï¼šæŽ¨é€åˆ° Telegram Bot"
        if: secrets.BOT_TOKEN != '' && secrets.CHAT_ID != ''
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          VERSION: ${{ env.VERSION }}
        run: |
          echo "ðŸ“± å‡†å¤‡æŽ¨é€åˆ° Telegram Bot..."

          # æ£€æŸ¥å¿…éœ€çš„çŽ¯å¢ƒå˜é‡
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸ è·³è¿‡ Telegram æŽ¨é€: æœªè®¾ç½® BOT_TOKEN æˆ– CHAT_ID"
            echo "è¯·åœ¨ GitHub Secrets ä¸­è®¾ç½® BOT_TOKEN å’Œ CHAT_ID"
            exit 0
          fi

          # å®‰è£… Python ä¾èµ–
          pip3 install requests

          # å‡†å¤‡æŽ¨é€ä¿¡æ¯
          export COMMIT="$(git log --oneline -n 5 --no-decorate | sed 's/^[0-9a-f]* //' | sed 's/^/â€” /')"

          # æŸ¥æ‰¾ç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶
          MODULE_FILE="${{ env.FILE_NAME }}"

          if [ -f "$MODULE_FILE" ]; then
            echo "ðŸ“¦ æ‰¾åˆ°æ¨¡å—æ–‡ä»¶: $MODULE_FILE"

            # åˆ›å»ºç®€åŒ–çš„æŽ¨é€è„šæœ¬
            cat > telegram_push.py << 'EOF'
          #!/usr/bin/env python3
          import os
          import sys
          import requests

          def send_to_telegram(file_path):
              bot_token = os.environ.get("BOT_TOKEN")
              chat_id = os.environ.get("CHAT_ID")
              version = os.environ.get("VERSION", "unknown")
              commit = os.environ.get("COMMIT", "Manual build")

              # å‡†å¤‡æ¶ˆæ¯
              caption = f"""
          {version}

          {commit}

          ðŸ”§ é»˜è®¤é…ç½®:
          â€¢ ä»£ç†æ ¸å¿ƒ: sing-box
          â€¢ ç½‘ç»œæ¨¡å¼: enhance (å¢žå¼ºæ¨¡å¼)
          â€¢ ä»£ç†è§„åˆ™: blacklist (é»‘åå•æ¨¡å¼)
          â€¢ UI ç•Œé¢: zashboard

          ðŸ”— [GitHub](https://github.com/taamarin/box_for_magisk)
          ðŸ“¦ [Releases](https://github.com/taamarin/box_for_magisk/releases)

          #BoxForRoot #Magisk #KernelSU #APatch #singbox #enhance #zashboard
          """.strip()

              # å‘é€æ–‡ä»¶
              url = f"https://api.telegram.org/bot{bot_token}/sendDocument"

              with open(file_path, 'rb') as file:
                  files = {'document': file}
                  data = {
                      'chat_id': chat_id,
                      'caption': caption,
                      'parse_mode': 'Markdown'
                  }

                  response = requests.post(url, files=files, data=data, timeout=60)

                  if response.status_code == 200:
                      result = response.json()
                      if result.get('ok'):
                          print("âœ… æ–‡ä»¶å‘é€æˆåŠŸ!")
                          return True
                      else:
                          print(f"âŒ å‘é€å¤±è´¥: {result.get('description', 'Unknown error')}")
                          return False
                  else:
                      print(f"âŒ HTTP é”™è¯¯ {response.status_code}: {response.text}")
                      return False

          if __name__ == "__main__":
              if len(sys.argv) < 2:
                  print("âŒ è¯·æä¾›æ–‡ä»¶è·¯å¾„")
                  sys.exit(1)

              file_path = sys.argv[1]
              if not os.path.isfile(file_path):
                  print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
                  sys.exit(1)

              if send_to_telegram(file_path):
                  print("ðŸŽ‰ Telegram æŽ¨é€å®Œæˆ!")
              else:
                  print("âŒ Telegram æŽ¨é€å¤±è´¥!")
                  sys.exit(1)
          EOF

            # æ‰§è¡ŒæŽ¨é€
            python3 telegram_push.py "$MODULE_FILE"
            echo "âœ… Telegram æŽ¨é€å®Œæˆ"
          else
            echo "âŒ æœªæ‰¾åˆ°æ¨¡å—æ–‡ä»¶: $MODULE_FILE"
            exit 1
          fi