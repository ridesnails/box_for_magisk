name: Build and Push to Telegram

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      core:
        description: 'ä»£ç†æ ¸å¿ƒé€‰æ‹©'
        required: false
        default: 'sing-box'
        type: choice
        options:
          - sing-box
          - clash
          - xray
          - v2fly
          - hysteria
      network_mode:
        description: 'ç½‘ç»œæ¨¡å¼'
        required: false
        default: 'enhance'
        type: choice
        options:
          - enhance
          - tproxy
          - redirect
          - mixed
          - tun
      ui:
        description: 'UI ç•Œé¢'
        required: false
        default: 'zashboard'
        type: choice
        options:
          - zashboard
          - yacd
          - metacubexd
      skip_telegram:
        description: 'è·³è¿‡ Telegram æŽ¨é€'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y curl unzip zip python3 python3-pip
        pip3 install requests

    - name: Set build parameters
      id: params
      run: |
        # è®¾ç½®é»˜è®¤å‚æ•°
        CORE="${{ github.event.inputs.core || 'sing-box' }}"
        NETWORK_MODE="${{ github.event.inputs.network_mode || 'enhance' }}"
        UI="${{ github.event.inputs.ui || 'zashboard' }}"
        SKIP_TELEGRAM="${{ github.event.inputs.skip_telegram || 'false' }}"
        
        echo "core=$CORE" >> $GITHUB_OUTPUT
        echo "network_mode=$NETWORK_MODE" >> $GITHUB_OUTPUT
        echo "ui=$UI" >> $GITHUB_OUTPUT
        echo "skip_telegram=$SKIP_TELEGRAM" >> $GITHUB_OUTPUT
        
        # è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="v$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # è®¾ç½®æž„å»ºä¿¡æ¯
        echo "build_date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Update module.prop
      run: |
        # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
        sed -i "s/^version=.*/version=${{ steps.params.outputs.version }}/" module.prop
        sed -i "s/^versionCode=.*/versionCode=${{ steps.params.outputs.build_date }}/" module.prop
        
        # æ˜¾ç¤ºæ›´æ–°åŽçš„ä¿¡æ¯
        echo "Updated module.prop:"
        cat module.prop

    - name: Configure workflow
      run: |
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x workflow_generator.sh
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        mkdir -p build
        
        echo "Build configuration:"
        echo "  Core: ${{ steps.params.outputs.core }}"
        echo "  Network Mode: ${{ steps.params.outputs.network_mode }}"
        echo "  UI: ${{ steps.params.outputs.ui }}"
        echo "  Version: ${{ steps.params.outputs.version }}"

    - name: Build module package
      run: |
        # è¿è¡Œå·¥ä½œæµç”Ÿæˆå™¨
        ./workflow_generator.sh \
          --core "${{ steps.params.outputs.core }}" \
          --mode "${{ steps.params.outputs.network_mode }}" \
          --ui "${{ steps.params.outputs.ui }}" \
          --build-only
        
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        ls -la build/
        
        # é‡å‘½åæ–‡ä»¶åŒ…å«é…ç½®ä¿¡æ¯
        cd build
        for file in *.zip; do
          if [ -f "$file" ]; then
            new_name="box_for_root-${{ steps.params.outputs.version }}-${{ steps.params.outputs.core }}-${{ steps.params.outputs.network_mode }}.zip"
            mv "$file" "$new_name"
            echo "Generated: $new_name"
            echo "module_file=$new_name" >> $GITHUB_ENV
          fi
        done

    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        # Box for Magisk ${{ steps.params.outputs.version }}
        
        ## ðŸ“¦ æž„å»ºä¿¡æ¯
        - **ç‰ˆæœ¬**: ${{ steps.params.outputs.version }}
        - **æž„å»ºæ—¥æœŸ**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **æäº¤**: ${{ steps.params.outputs.commit_sha }}
        
        ## âš™ï¸ é…ç½®ä¿¡æ¯
        - **ä»£ç†æ ¸å¿ƒ**: ${{ steps.params.outputs.core }}
        - **ç½‘ç»œæ¨¡å¼**: ${{ steps.params.outputs.network_mode }}
        - **UI ç•Œé¢**: ${{ steps.params.outputs.ui }}
        
        ## ðŸš€ é»˜è®¤é…ç½®
        - **é€æ˜Žä»£ç†**: é»‘åå•æ¨¡å¼
        - **IPv6**: å·²ç¦ç”¨
        - **ç«¯å£é…ç½®**: tproxy 9898, redirect 9797
        
        ## ðŸ“± å®‰è£…æ–¹æ³•
        1. ä¸‹è½½æ¨¡å—åŒ…
        2. é€šè¿‡ Magisk/KernelSU/APatch Manager å®‰è£…
        3. é‡å¯è®¾å¤‡
        4. è®¿é—®æŽ§åˆ¶é¢æ¿: http://127.0.0.1:9090/ui/
        
        ## ðŸ”— ç›¸å…³é“¾æŽ¥
        - [GitHub Repository](https://github.com/taamarin/box_for_magisk)
        - [ä½¿ç”¨æ–‡æ¡£](https://github.com/taamarin/box_for_magisk/blob/master/README.md)
        - [é—®é¢˜åé¦ˆ](https://t.me/taamarin)
        
        #BoxForRoot #Magisk #KernelSU #APatch #${{ steps.params.outputs.core }}
        EOF
        
        # è¾“å‡ºå‘å¸ƒè¯´æ˜Ž
        echo "Generated release notes:"
        cat release_notes.md

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.params.outputs.version }}
        name: "Box for Magisk ${{ steps.params.outputs.version }}"
        body_path: release_notes.md
        files: build/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: box-for-magisk-${{ steps.params.outputs.version }}
        path: build/*.zip
        retention-days: 30

    - name: Push to Telegram Bot
      if: steps.params.outputs.skip_telegram != 'true' && (secrets.BOT_TOKEN != '' && secrets.CHAT_ID != '')
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
        VERSION: ${{ steps.params.outputs.version }}
      run: |
        echo "ðŸ“± æŽ¨é€åˆ° Telegram Bot..."

        # è®¾ç½®æäº¤ä¿¡æ¯
        export COMMIT="$(git log --oneline -n 5 --no-decorate | sed 's/^[0-9a-f]* //' | sed 's/^/â€” /')"

        # æŸ¥æ‰¾æ¨¡å—æ–‡ä»¶
        MODULE_FILE=$(find build -name "*.zip" | head -1)

        if [ -f "$MODULE_FILE" ]; then
          echo "ðŸ“¦ æ‰¾åˆ°æ¨¡å—æ–‡ä»¶: $MODULE_FILE"

          # ä½¿ç”¨æ–°çš„æŽ¨é€è„šæœ¬
          if [ -f ".github/telegram_push.py" ]; then
            python3 .github/telegram_push.py "$MODULE_FILE"
            echo "âœ… æˆåŠŸæŽ¨é€åˆ° Telegram"
          elif [ -f ".github/taamarinbot.py" ]; then
            # å¤‡ç”¨ï¼šä½¿ç”¨åŽŸæœ‰è„šæœ¬
            python3 .github/taamarinbot.py "$MODULE_FILE"
            echo "âœ… æˆåŠŸæŽ¨é€åˆ° Telegram (ä½¿ç”¨å¤‡ç”¨è„šæœ¬)"
          else
            echo "âŒ æœªæ‰¾åˆ° Telegram æŽ¨é€è„šæœ¬"
            exit 1
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°æ¨¡å—æ–‡ä»¶"
          exit 1
        fi

    - name: Cleanup
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf /tmp/box_workflow* || true
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸŽ¯ æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| ç‰ˆæœ¬ | ${{ steps.params.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æ ¸å¿ƒ | ${{ steps.params.outputs.core }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ç½‘ç»œæ¨¡å¼ | ${{ steps.params.outputs.network_mode }} |" >> $GITHUB_STEP_SUMMARY
        echo "| UI | ${{ steps.params.outputs.ui }} |" >> $GITHUB_STEP_SUMMARY
        echo "| æž„å»ºçŠ¶æ€ | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "build/*.zip" ]; then
          echo "### ðŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la build/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
