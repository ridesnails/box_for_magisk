# ===================================================================================
# å·¥ä½œæµåç§°: æ„å»ºä¸æ¨é€
# ===================================================================================
name: "ğŸ“¦ æ„å»ºå¹¶æ¨é€æ¨¡å—åŒ…"

# ===================================================================================
# è§¦å‘æ¡ä»¶:
# 1. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
# 2. å½“ simple åˆ†æ”¯æœ‰ä»£ç æ¨é€æ—¶è§¦å‘ï¼Œä½†ä»…é™äºç‰¹å®šæ–‡ä»¶æˆ–ç›®å½•å‘ç”Ÿå˜åŒ–æ—¶
#    - è¿™æ¶µç›–äº†â€œupstreamæœ‰æ›´æ–°â€å’Œâ€œsing-boxæ ¸å¿ƒæœ‰æ¨é€æ›´æ–°â€ä¸¤ç§æƒ…å†µ
# ===================================================================================
on:
  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

  # å½“æœ‰ä»£ç æ¨é€åˆ° simple åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - simple

# ===================================================================================
# ä»»åŠ¡ (Jobs)
# ===================================================================================
jobs:
  # å®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„ä»»åŠ¡ï¼Œè´Ÿè´£æ‰€æœ‰äº‹æƒ…
  build-and-release:
    # ä»»åŠ¡çš„æ˜¾ç¤ºåç§°
    name: "ğŸ—ï¸ æ„å»ºå¹¶å‘å¸ƒæ¨¡å—"
    # è¿è¡Œæ­¤ä»»åŠ¡æ‰€éœ€çš„è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest
    # ä¸ºæ­¤ä»»åŠ¡æˆäºˆå†™æƒé™ï¼Œä»¥ä¾¿å®ƒå¯ä»¥åˆ›å»º GitHub Release
    permissions:
      contents: write

    # ä»»åŠ¡çš„æ‰§è¡Œæ­¥éª¤
    steps:
      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # -----------------------------------------------------------------------------
      - name: "ğŸšš ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ä»£ç ä»“åº“"
        uses: actions/checkout@v4
        with:
          # æ‹‰å–æ‰€æœ‰ git å†å²è®°å½•ï¼Œè¿™å¯¹äºåç»­è·å– commit hash æ˜¯å¿…éœ€çš„
          fetch-depth: 0

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 2: å‡†å¤‡ç¯å¢ƒå’Œç‰ˆæœ¬ä¿¡æ¯
      # -----------------------------------------------------------------------------
      - name: "âš™ï¸ ç¬¬äºŒæ­¥ï¼šç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯"
        id: versioning # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ªIDï¼Œæ–¹ä¾¿åç»­å¼•ç”¨å®ƒçš„è¾“å‡º
        run: |
          # æ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼šä» Git commit æ¶ˆæ¯ä¸­æå– sing-box ç‰ˆæœ¬ä¿¡æ¯
          # å› ä¸º box/bin/sing-box æ˜¯ Android ARM64 ç‰ˆæœ¬ï¼Œæ— æ³•åœ¨ Linux ç¯å¢ƒä¸­æ‰§è¡Œ
          echo "â„¹ï¸ ä» Git commit æ¶ˆæ¯ä¸­è·å– sing-box ç‰ˆæœ¬..."

          # è·å–æœ€æ–°çš„ commit æ¶ˆæ¯
          LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
          echo "ğŸ“ æœ€æ–° commit: $LATEST_COMMIT"

          # ä» commit æ¶ˆæ¯ä¸­æå–ç‰ˆæœ¬å·
          # åŒ¹é…æ¨¡å¼: "Update sing-box binary to v1.12.0-beta.28-reF1nd (Android ARM64)"
          # æå–: "1.12.0-beta.28-reF1nd"
          if echo "$LATEST_COMMIT" | grep -q "Update sing-box binary to v"; then
            CORE_VERSION=$(echo "$LATEST_COMMIT" | sed -n 's/.*Update sing-box binary to v\([^ ]*\).*/\1/p')
            echo "âœ… ä» commit æ¶ˆæ¯ä¸­æå–åˆ°ç‰ˆæœ¬: $CORE_VERSION"
          else
            # å¦‚æœ commit æ¶ˆæ¯ä¸­æ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
            CORE_VERSION="unknown"
            echo "âš ï¸ æœªåœ¨ commit æ¶ˆæ¯ä¸­æ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $CORE_VERSION"
          fi
          
          # è·å–å½“å‰ Git æäº¤çš„çŸ­å“ˆå¸Œå€¼ (å‰7ä½)
          echo "â„¹ï¸ è·å– Git Commit Hash..."
          GIT_HASH=$(git rev-parse --short HEAD)

          # ç»„åˆæˆæœ€ç»ˆçš„æ¨¡å—ç‰ˆæœ¬å·ï¼Œæ ¼å¼ä¸ºï¼š[æ ¸å¿ƒç‰ˆæœ¬]+[commitå“ˆå¸Œ]
          FINAL_VERSION="${CORE_VERSION}+${GIT_HASH}"
          echo "âœ… æˆåŠŸç”Ÿæˆç‰ˆæœ¬å·: ${FINAL_VERSION}"

          # å°†ç‰ˆæœ¬å·å’Œæ‰“åŒ…æ–‡ä»¶åè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION=${FINAL_VERSION}" >> $GITHUB_ENV
          echo "FILE_NAME=Box_for_Magisk-simple-${FINAL_VERSION}.zip" >> $GITHUB_ENV
          
          # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºæ­¤æ­¥éª¤çš„è¾“å‡ºï¼Œä¾› release æ­¥éª¤ä½¿ç”¨
          echo "TAG=${FINAL_VERSION}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 3: æ›´æ–°æ¨¡å—ä¿¡æ¯æ–‡ä»¶
      # -----------------------------------------------------------------------------
      - name: "ğŸ“ ç¬¬ä¸‰æ­¥ï¼šæ›´æ–° module.prop æ–‡ä»¶"
        run: |
          echo "âœï¸ å°†ç‰ˆæœ¬å·å†™å…¥ module.prop..."
          # ä½¿ç”¨ sed å‘½ä»¤å°† module.prop æ–‡ä»¶ä¸­çš„ version=xxxx è¿™ä¸€è¡Œç²¾ç¡®æ›¿æ¢ä¸ºæˆ‘ä»¬æ–°ç”Ÿæˆçš„ç‰ˆæœ¬å·
          sed -i "s/^version=.*/version=${{ env.VERSION }}/" module.prop
          echo "âœ… module.prop æ›´æ–°å®Œæ¯•ï¼"
          cat module.prop # æ‰“å°å‡ºæ¥æ£€æŸ¥ä¸€ä¸‹

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 4: åº”ç”¨é»˜è®¤é…ç½®ä¿®æ”¹
      # -----------------------------------------------------------------------------
      - name: "âš™ï¸ ç¬¬å››æ­¥ï¼šåº”ç”¨é»˜è®¤é…ç½®ä¿®æ”¹"
        run: |
          echo "ğŸ”§ å¼€å§‹åº”ç”¨é»˜è®¤é…ç½®..."

          # 1. è®¾ç½®é»˜è®¤ç½‘ç»œæ¨¡å¼ä¸º enhanceï¼ˆå¢å¼ºæ¨¡å¼ï¼‰
          echo "ğŸ“¡ è®¾ç½®é»˜è®¤ç½‘ç»œæ¨¡å¼ä¸º enhance..."
          if [ -f "box/settings.ini" ]; then
            sed -i 's/^network_mode=.*/network_mode="enhance"/' box/settings.ini
            echo "âœ… ç½‘ç»œæ¨¡å¼å·²è®¾ç½®ä¸º enhance"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° box/settings.ini æ–‡ä»¶"
          fi

          # 2. è®¾ç½®é»˜è®¤ä»£ç†æ ¸å¿ƒä¸º sing-box
          echo "ğŸ¯ è®¾ç½®é»˜è®¤ä»£ç†æ ¸å¿ƒä¸º sing-box..."
          if [ -f "box/settings.ini" ]; then
            sed -i 's/^bin_name=.*/bin_name="sing-box"/' box/settings.ini
            echo "âœ… ä»£ç†æ ¸å¿ƒå·²è®¾ç½®ä¸º sing-box"
          fi

          # 3. è®¾ç½®é»˜è®¤é€æ˜ä»£ç†è§„åˆ™ä¸ºé»‘åå•æ¨¡å¼
          echo "ğŸš« è®¾ç½®é»˜è®¤é€æ˜ä»£ç†è§„åˆ™ä¸ºé»‘åå•æ¨¡å¼..."
          if [ -f "box/package.list.cfg" ]; then
            sed -i 's/^mode:.*/mode:blacklist/' box/package.list.cfg
            echo "âœ… é€æ˜ä»£ç†è§„åˆ™å·²è®¾ç½®ä¸ºé»‘åå•æ¨¡å¼"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° box/package.list.cfg æ–‡ä»¶"
          fi

          # 4. ä¸‹è½½å¹¶é›†æˆ zashboard UI æ›¿ä»£é»˜è®¤ yacd
          echo "ğŸ¨ ä¸‹è½½å¹¶é›†æˆ zashboard UI..."
          ZASHBOARD_URL="https://github.com/Zephyruso/zashboard/archive/refs/heads/gh-pages.zip"
          UI_DIR="box/sing-box/dashboard"

          # åˆ›å»º UI ç›®å½•
          mkdir -p "$UI_DIR"

          # ä¸‹è½½ zashboard
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ zashboard..."
          curl -L -o zashboard.zip "$ZASHBOARD_URL"

          # è§£å‹å¹¶å®‰è£…
          if [ -f "zashboard.zip" ]; then
            echo "ğŸ“‚ æ­£åœ¨è§£å‹ zashboard..."
            unzip -q zashboard.zip

            # æŸ¥æ‰¾è§£å‹åçš„ç›®å½•
            ZASHBOARD_DIR=$(find . -name "zashboard-gh-pages" -type d | head -1)

            if [ -d "$ZASHBOARD_DIR" ]; then
              echo "ğŸ“‹ æ­£åœ¨å®‰è£… zashboard åˆ° $UI_DIR..."
              cp -r "$ZASHBOARD_DIR"/* "$UI_DIR/"
              echo "âœ… zashboard UI å®‰è£…å®Œæˆ"

              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -rf zashboard.zip "$ZASHBOARD_DIR"
            else
              echo "âŒ æœªæ‰¾åˆ° zashboard è§£å‹ç›®å½•"
            fi
          else
            echo "âŒ zashboard ä¸‹è½½å¤±è´¥"
          fi

          # 5. ä¿®å¤ sing-box é…ç½®æ–‡ä»¶ä¸­çš„ RuleSet é—®é¢˜
          echo "ğŸ”§ æ£€æŸ¥å¹¶ä¿®å¤ sing-box é…ç½®æ–‡ä»¶..."
          CONFIG_FILE="box/sing-box/config.json"

          if [ -f "$CONFIG_FILE" ]; then
            echo "ğŸ“‹ æ£€æŸ¥é…ç½®æ–‡ä»¶: $CONFIG_FILE"

            # å¤‡ä»½åŸå§‹é…ç½®æ–‡ä»¶
            cp "$CONFIG_FILE" "$CONFIG_FILE.backup"

            # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ rule_set ç›¸å…³é…ç½®
            if grep -q "rule_set" "$CONFIG_FILE"; then
              echo "ğŸ” å‘ç° rule_set é…ç½®ï¼Œè¿›è¡Œä¿®å¤..."

              # ä½¿ç”¨ Python è„šæœ¬ä¿®å¤ JSON é…ç½®ä¸­çš„ null RuleSet
              python3 << 'EOF'
import json
import sys

try:
    with open('box/sing-box/config.json', 'r', encoding='utf-8') as f:
        config = json.load(f)

    # æ£€æŸ¥å¹¶ä¿®å¤ route.rule_set
    if 'route' in config and 'rule_set' in config['route']:
        rule_sets = config['route']['rule_set']
        if rule_sets is None:
            print("ğŸ”§ ä¿®å¤ route.rule_set: null -> []")
            config['route']['rule_set'] = []
        elif isinstance(rule_sets, list):
            # è¿‡æ»¤æ‰ null å…ƒç´ 
            original_count = len(rule_sets)
            config['route']['rule_set'] = [rs for rs in rule_sets if rs is not None]
            new_count = len(config['route']['rule_set'])
            if original_count != new_count:
                print(f"ğŸ”§ ç§»é™¤äº† {original_count - new_count} ä¸ª null RuleSet å…ƒç´ ")

    # æ£€æŸ¥å¹¶ä¿®å¤ route.rules ä¸­çš„ rule_set å¼•ç”¨
    if 'route' in config and 'rules' in config['route']:
        for i, rule in enumerate(config['route']['rules']):
            if isinstance(rule, dict) and 'rule_set' in rule:
                if rule['rule_set'] is None:
                    print(f"ğŸ”§ ä¿®å¤ route.rules[{i}].rule_set: null -> []")
                    rule['rule_set'] = []
                elif isinstance(rule['rule_set'], list):
                    original = rule['rule_set'][:]
                    rule['rule_set'] = [rs for rs in rule['rule_set'] if rs is not None and rs != ""]
                    if len(original) != len(rule['rule_set']):
                        print(f"ğŸ”§ æ¸…ç†äº† route.rules[{i}].rule_set ä¸­çš„æ— æ•ˆå¼•ç”¨")

    # ä¿å­˜ä¿®å¤åçš„é…ç½®
    with open('box/sing-box/config.json', 'w', encoding='utf-8') as f:
        json.dump(config, f, indent=2, ensure_ascii=False)

    print("âœ… é…ç½®æ–‡ä»¶ä¿®å¤å®Œæˆ")

except Exception as e:
    print(f"âŒ é…ç½®æ–‡ä»¶ä¿®å¤å¤±è´¥: {e}")
    # æ¢å¤å¤‡ä»½
    import shutil
    shutil.copy('box/sing-box/config.json.backup', 'box/sing-box/config.json')
    print("ğŸ”„ å·²æ¢å¤åŸå§‹é…ç½®æ–‡ä»¶")
EOF
            else
              echo "â„¹ï¸ é…ç½®æ–‡ä»¶ä¸­æœªå‘ç° rule_set é…ç½®"
            fi

            echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° sing-box é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          fi

          # 5. æ˜¾ç¤ºé…ç½®æ‘˜è¦
          echo ""
          echo "ğŸ“‹ é…ç½®æ‘˜è¦ï¼š"
          echo "  ğŸ¯ ä»£ç†æ ¸å¿ƒ: sing-box"
          echo "  ğŸ“¡ ç½‘ç»œæ¨¡å¼: enhance (å¢å¼ºæ¨¡å¼)"
          echo "  ğŸš« ä»£ç†è§„åˆ™: blacklist (é»‘åå•æ¨¡å¼)"
          echo "  ğŸ¨ UI ç•Œé¢: zashboard"
          echo "âœ… é»˜è®¤é…ç½®åº”ç”¨å®Œæˆï¼"

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 5: æ‰“åŒ…æ¨¡å—æ–‡ä»¶
      # -----------------------------------------------------------------------------
      - name: "ğŸ“¦ ç¬¬äº”æ­¥ï¼šæ‰“åŒ…æ¨¡å—ä¸º ZIP æ–‡ä»¶"
        run: |
          echo "âš™ï¸ å¼€å§‹æ‰“åŒ…..."
          # ä½¿ç”¨ zip å‘½ä»¤æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶
          # -r è¡¨ç¤ºé€’å½’æ‰“åŒ…å­ç›®å½•, -9 è¡¨ç¤ºæœ€é«˜å‹ç¼©ç‡, -q è¡¨ç¤ºé™é»˜æ¨¡å¼
          zip -r9q ${{ env.FILE_NAME }} . -x ".git/*" ".github/*" "README.md"
          echo "âœ… æ‰“åŒ…å®Œæˆ: ${{ env.FILE_NAME }}"

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 6: åˆ›å»º GitHub Release
      # -----------------------------------------------------------------------------
      - name: "ğŸš€ ç¬¬å…­æ­¥ï¼šåˆ›å»º GitHub é¢„å‘å¸ƒç‰ˆæœ¬"
        uses: softprops/action-gh-release@v1
        with:
          # è¦ä¸Šä¼ çš„é™„ä»¶æ–‡ä»¶ï¼Œå³æˆ‘ä»¬æ‰“åŒ…å¥½çš„ zip åŒ…
          files: ${{ env.FILE_NAME }}
          # Release çš„æ ‡ç­¾åï¼Œä½¿ç”¨æˆ‘ä»¬ç”Ÿæˆçš„å”¯ä¸€ç‰ˆæœ¬å·
          tag_name: ${{ steps.versioning.outputs.TAG }}
          # Release çš„æ ‡é¢˜
          name: "æ»šåŠ¨æ›´æ–° ${{ steps.versioning.outputs.TAG }}"
          # Release çš„æ­£æ–‡å†…å®¹ï¼Œä½¿ç”¨ Markdown æ ¼å¼
          body: |
            è‡ªåŠ¨æ„å»ºäº `simple` åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚
            - **sing-box æ ¸å¿ƒç‰ˆæœ¬:** `${{ env.VERSION }}`
            - **æ„å»ºæ—¶é—´:** `$(date -u)`
            - **æäº¤å“ˆå¸Œ:** `${{ github.sha }}`
          # å°†æ­¤ Release æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œé€‚åˆæ»šåŠ¨æ›´æ–°
          prerelease: true

      # -----------------------------------------------------------------------------
      # æ­¥éª¤ 7: æ¨é€åˆ° Telegram Bot
      # -----------------------------------------------------------------------------
      - name: "ğŸ“± ç¬¬ä¸ƒæ­¥ï¼šæ¨é€åˆ° Telegram Bot"
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          VERSION: ${{ env.VERSION }}
        run: |
          echo "ğŸ“± å‡†å¤‡æ¨é€åˆ° Telegram Bot..."

          # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸ è·³è¿‡ Telegram æ¨é€: æœªè®¾ç½® BOT_TOKEN æˆ– CHAT_ID"
            echo "è¯·åœ¨ GitHub Secrets ä¸­è®¾ç½® BOT_TOKEN å’Œ CHAT_ID"
            exit 0
          fi

          # å®‰è£… Python ä¾èµ–
          pip3 install requests

          # å‡†å¤‡æ¨é€ä¿¡æ¯
          export COMMIT="$(git log --oneline -n 5 --no-decorate | sed 's/^[0-9a-f]* //' | sed 's/^/â€” /')"

          # æŸ¥æ‰¾ç”Ÿæˆçš„æ¨¡å—æ–‡ä»¶
          MODULE_FILE="${{ env.FILE_NAME }}"

          if [ -f "$MODULE_FILE" ]; then
            echo "ğŸ“¦ æ‰¾åˆ°æ¨¡å—æ–‡ä»¶: $MODULE_FILE"

            # åˆ›å»ºç®€åŒ–çš„æ¨é€è„šæœ¬
            cat > telegram_push.py << 'EOF'
          #!/usr/bin/env python3
          import os
          import sys
          import requests

          def send_to_telegram(file_path):
              bot_token = os.environ.get("BOT_TOKEN")
              chat_id = os.environ.get("CHAT_ID")
              version = os.environ.get("VERSION", "unknown")
              commit = os.environ.get("COMMIT", "Manual build")

              # å‡†å¤‡æ¶ˆæ¯
              caption = f"""
          {version}

          {commit}

          ğŸ”§ é»˜è®¤é…ç½®:
          â€¢ ä»£ç†æ ¸å¿ƒ: sing-box
          â€¢ ç½‘ç»œæ¨¡å¼: enhance (å¢å¼ºæ¨¡å¼)
          â€¢ ä»£ç†è§„åˆ™: blacklist (é»‘åå•æ¨¡å¼)
          â€¢ UI ç•Œé¢: zashboard

          ğŸ”— [GitHub](https://github.com/taamarin/box_for_magisk)
          ğŸ“¦ [Releases](https://github.com/taamarin/box_for_magisk/releases)

          #BoxForRoot #Magisk #KernelSU #APatch #singbox #enhance #zashboard
          """.strip()

              # å‘é€æ–‡ä»¶
              url = f"https://api.telegram.org/bot{bot_token}/sendDocument"

              with open(file_path, 'rb') as file:
                  files = {'document': file}
                  data = {
                      'chat_id': chat_id,
                      'caption': caption,
                      'parse_mode': 'Markdown'
                  }

                  response = requests.post(url, files=files, data=data, timeout=60)

                  if response.status_code == 200:
                      result = response.json()
                      if result.get('ok'):
                          print("âœ… æ–‡ä»¶å‘é€æˆåŠŸ!")
                          return True
                      else:
                          print(f"âŒ å‘é€å¤±è´¥: {result.get('description', 'Unknown error')}")
                          return False
                  else:
                      print(f"âŒ HTTP é”™è¯¯ {response.status_code}: {response.text}")
                      return False

          if __name__ == "__main__":
              if len(sys.argv) < 2:
                  print("âŒ è¯·æä¾›æ–‡ä»¶è·¯å¾„")
                  sys.exit(1)

              file_path = sys.argv[1]
              if not os.path.isfile(file_path):
                  print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
                  sys.exit(1)

              if send_to_telegram(file_path):
                  print("ğŸ‰ Telegram æ¨é€å®Œæˆ!")
              else:
                  print("âŒ Telegram æ¨é€å¤±è´¥!")
                  sys.exit(1)
          EOF

            # æ‰§è¡Œæ¨é€
            python3 telegram_push.py "$MODULE_FILE"
            echo "âœ… Telegram æ¨é€å®Œæˆ"
          else
            echo "âŒ æœªæ‰¾åˆ°æ¨¡å—æ–‡ä»¶: $MODULE_FILE"
            exit 1
          fi