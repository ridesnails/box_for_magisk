name: ğŸ”„ Update sing-box Core

on:
  schedule:
    # æ¯å¤©çš„ 02:00 å’Œ 14:00 UTC æ£€æŸ¥æ›´æ–° (é¿å…GitHub APIé™åˆ¶)
    - cron: '0 2,14 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      include_beta:
        description: 'åŒ…å«Betaç‰ˆæœ¬'
        required: false
        default: true
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  check-singbox-version:
    runs-on: ubuntu-latest
    outputs:
      should_update: ${{ steps.check.outputs.should_update }}
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
      download_urls: ${{ steps.check.outputs.download_urls }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” æ£€æŸ¥sing-boxç‰ˆæœ¬
      id: check
      run: |
        # è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
        if [ -f "box/bin/.bin" ]; then
          current_version=$(grep -o 'sing-box:[^:]*' box/bin/.bin | cut -d':' -f2 || echo "unknown")
        else
          current_version="unknown"
        fi
        echo "current_version=$current_version" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: $current_version"
        
        # æ£€æŸ¥GitHub APIé™åˆ¶
        api_remaining=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/rate_limit" | jq -r '.rate.remaining')
        echo "ğŸ”¥ GitHub APIå‰©ä½™è°ƒç”¨æ¬¡æ•°: $api_remaining"
        
        if [ "$api_remaining" -lt 10 ]; then
          echo "âš ï¸ GitHub APIè°ƒç”¨æ¬¡æ•°ä¸è¶³ï¼Œè·³è¿‡æ­¤æ¬¡æ£€æŸ¥"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        if [ "${{ github.event.inputs.include_beta }}" = "true" ]; then
          # åŒ…å«é¢„å‘å¸ƒç‰ˆæœ¬
          latest_release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/SagerNet/sing-box/releases" | \
            jq -r '.[0]')
        else
          # ä»…ç¨³å®šç‰ˆæœ¬
          latest_release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/SagerNet/sing-box/releases/latest")
        fi
        
        new_version=$(echo "$latest_release" | jq -r '.tag_name')
        release_name=$(echo "$latest_release" | jq -r '.name')
        is_prerelease=$(echo "$latest_release" | jq -r '.prerelease')
        
        echo "ğŸ¯ æœ€æ–°ç‰ˆæœ¬: $new_version"
        echo "ğŸ“ å‘å¸ƒåç§°: $release_name"
        echo "ğŸ§ª é¢„å‘å¸ƒç‰ˆæœ¬: $is_prerelease"
        echo "new_version=$new_version" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        should_update=false
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          should_update=true
          echo "ğŸ”„ å¼ºåˆ¶æ›´æ–°æ¨¡å¼"
        elif [ "$current_version" != "$new_version" ] && [ "$new_version" != "null" ]; then
          should_update=true
          echo "âœ… å‘ç°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ–°"
        else
          echo "ğŸ“‹ ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
        fi
        
        echo "should_update=$should_update" >> $GITHUB_OUTPUT
        
        # æ„å»ºä¸‹è½½URLåˆ—è¡¨
        if [ "$should_update" = "true" ]; then
          # è·å–èµ„äº§ä¸‹è½½é“¾æ¥
          download_urls=$(echo "$latest_release" | jq -r '.assets[] | 
            select(.name | test("sing-box-.*-linux-(amd64|arm64|armv7)\\.tar\\.gz$")) | 
            .browser_download_url' | tr '\n' ' ')
          echo "ğŸ“¦ ä¸‹è½½é“¾æ¥: $download_urls"
          echo "download_urls=$download_urls" >> $GITHUB_OUTPUT
        fi

  update-singbox:
    needs: check-singbox-version
    if: needs.check-singbox-version.outputs.should_update == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âš™ï¸ è®¾ç½®Gité…ç½®
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: ğŸ“¦ ä¸‹è½½å’Œæ›´æ–°sing-boxäºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        new_version="${{ needs.check-singbox-version.outputs.new_version }}"
        download_urls="${{ needs.check-singbox-version.outputs.download_urls }}"
        
        echo "ğŸ”„ å¼€å§‹æ›´æ–°sing-boxåˆ°ç‰ˆæœ¬: $new_version"
        
        # åˆ›å»ºä¸´æ—¶ä¸‹è½½ç›®å½•
        mkdir -p temp_download
        cd temp_download
        
        # ä¸‹è½½å„æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
        success_count=0
        total_count=0
        
        for url in $download_urls; do
          filename=$(basename "$url")
          total_count=$((total_count + 1))
          
          echo "ğŸ“¥ ä¸‹è½½: $filename"
          
          # é‡è¯•æœºåˆ¶ä¸‹è½½
          retry_count=0
          max_retries=3
          
          while [ $retry_count -lt $max_retries ]; do
            if curl -L -f -o "$filename" "$url"; then
              echo "âœ… ä¸‹è½½æˆåŠŸ: $filename"
              
              # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
              if [ -s "$filename" ] && file "$filename" | grep -q "gzip compressed"; then
                # è§£å‹å¹¶æå–äºŒè¿›åˆ¶æ–‡ä»¶
                tar -xzf "$filename"
                
                # æŸ¥æ‰¾sing-boxäºŒè¿›åˆ¶æ–‡ä»¶
                singbox_binary=$(find . -name "sing-box" -type f | head -1)
                
                if [ -n "$singbox_binary" ] && [ -x "$singbox_binary" ]; then
                  # æ£€æµ‹æ¶æ„
                  if echo "$filename" | grep -q "amd64"; then
                    arch="amd64"
                  elif echo "$filename" | grep -q "arm64"; then
                    arch="arm64"
                  elif echo "$filename" | grep -q "armv7"; then
                    arch="armv7"
                  else
                    arch="unknown"
                  fi
                  
                  # å¤åˆ¶åˆ°å¯¹åº”ç›®å½•
                  mkdir -p "../box/bin/$arch"
                  cp "$singbox_binary" "../box/bin/$arch/sing-box"
                  chmod +x "../box/bin/$arch/sing-box"
                  
                  echo "âœ… æˆåŠŸå®‰è£… $arch æ¶æ„çš„sing-box"
                  success_count=$((success_count + 1))
                else
                  echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„sing-boxäºŒè¿›åˆ¶æ–‡ä»¶åœ¨ $filename"
                fi
                
                # æ¸…ç†è§£å‹çš„æ–‡ä»¶
                find . -mindepth 1 -maxdepth 1 -type d -exec rm -rf {} +
              else
                echo "âŒ æ–‡ä»¶å®Œæ•´æ€§éªŒè¯å¤±è´¥: $filename"
              fi
              break
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ (å°è¯• $retry_count/$max_retries): $filename"
              sleep 5
            fi
          done
          
          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ ä¸‹è½½æœ€ç»ˆå¤±è´¥: $filename"
          fi
        done
        
        cd ..
        rm -rf temp_download
        
        echo "ğŸ“Š ä¸‹è½½ç»Ÿè®¡: $success_count/$total_count æˆåŠŸ"
        
        if [ $success_count -eq 0 ]; then
          echo "âŒ æ‰€æœ‰ä¸‹è½½éƒ½å¤±è´¥äº†"
          exit 1
        fi
        
        # æ›´æ–°.binæ–‡ä»¶
        echo "sing-box:$new_version" > box/bin/.bin
        
        # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯åˆ°update.json
        current_date=$(date +"%Y%m%d")
        jq --arg version "$new_version" \
           --arg versionCode "$current_date" \
           '.version = $version | .versionCode = $versionCode' \
           update.json > update.json.tmp && mv update.json.tmp update.json

    - name: ğŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—
      run: |
        new_version="${{ needs.check-singbox-version.outputs.new_version }}"
        current_version="${{ needs.check-singbox-version.outputs.current_version }}"
        current_date=$(date +"%Y-%m-%d")
        current_time=$(date +"%Y-%m-%d %H:%M:%S UTC")
        
        # è·å–sing-boxå‘å¸ƒè¯´æ˜
        release_notes=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/SagerNet/sing-box/releases/tags/$new_version" | \
          jq -r '.body // "æ— å‘å¸ƒè¯´æ˜"')
        
        # åˆ›å»ºæ›´æ–°æ—¥å¿—æ¡ç›®
        {
          echo ""
          echo "## [$new_version] - $current_date"
          echo ""
          echo "### ğŸ”„ sing-boxæ ¸å¿ƒæ›´æ–°"
          echo "- æ›´æ–°ç‰ˆæœ¬: $current_version â†’ $new_version"
          echo "- æ›´æ–°æ—¶é—´: $current_time"
          echo "- æ›´æ–°æ–¹å¼: è‡ªåŠ¨æ›´æ–°"
          echo ""
          echo "### ğŸ“‹ sing-boxå‘å¸ƒè¯´æ˜"
          echo "$release_notes"
          echo ""
          echo "### ğŸ—ï¸ æ¶æ„æ”¯æŒ"
          echo "- linux-amd64"
          echo "- linux-arm64"
          echo "- linux-armv7"
          echo ""
        } >> CHANGELOG.md

    - name: ğŸ” éªŒè¯æ›´æ–°
      run: |
        # æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        for arch in amd64 arm64 armv7; do
          if [ -f "box/bin/$arch/sing-box" ]; then
            echo "âœ… $arch: äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨"
            file_info=$(file "box/bin/$arch/sing-box")
            echo "   æ–‡ä»¶ä¿¡æ¯: $file_info"
          else
            echo "âŒ $arch: äºŒè¿›åˆ¶æ–‡ä»¶ç¼ºå¤±"
          fi
        done
        
        # æ£€æŸ¥.binæ–‡ä»¶
        if [ -f "box/bin/.bin" ]; then
          echo "âœ… .binæ–‡ä»¶å·²æ›´æ–°: $(cat box/bin/.bin)"
        else
          echo "âŒ .binæ–‡ä»¶ç¼ºå¤±"
        fi
        
        # æ£€æŸ¥update.jsonæ–‡ä»¶
        if [ -f "update.json" ]; then
          echo "âœ… update.jsonå·²æ›´æ–°:"
          cat update.json | jq .
        else
          echo "âŒ update.jsonæ–‡ä»¶ç¼ºå¤±"
        fi

    - name: ğŸ“¤ æäº¤å˜æ›´
      run: |
        new_version="${{ needs.check-singbox-version.outputs.new_version }}"
        current_time=$(date +"%Y-%m-%d %H:%M:%S UTC")
        
        git add .
        
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°sing-boxåˆ° $new_version" \
                     -m "- æ›´æ–°sing-boxæ ¸å¿ƒåˆ°ç‰ˆæœ¬ $new_version" \
                     -m "- æ”¯æŒå¤šæ¶æ„: amd64, arm64, armv7" \
                     -m "- è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯å’Œé…ç½®æ–‡ä»¶" \
                     -m "- æ›´æ–°æ—¶é—´: $current_time" \
                     -m "" \
                     -m "Co-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          
          echo "âœ… å˜æ›´å·²æäº¤"
        else
          echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
        fi

    - name: ğŸš€ åˆ›å»ºPull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ”„ è‡ªåŠ¨æ›´æ–°sing-boxåˆ° ${{ needs.check-singbox-version.outputs.new_version }}"
        title: "ğŸ”„ è‡ªåŠ¨æ›´æ–°sing-boxæ ¸å¿ƒåˆ° ${{ needs.check-singbox-version.outputs.new_version }}"
        body: |
          ## ğŸ”„ sing-boxè‡ªåŠ¨æ›´æ–°
          
          **å½“å‰ç‰ˆæœ¬**: `${{ needs.check-singbox-version.outputs.current_version }}`
          **æ–°ç‰ˆæœ¬**: `${{ needs.check-singbox-version.outputs.new_version }}`
          **æ›´æ–°æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          - âœ… æ›´æ–°sing-boxæ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
          - âœ… æ”¯æŒå¤šæ¶æ„ (amd64, arm64, armv7)
          - âœ… æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          - âœ… è‡ªåŠ¨ç”Ÿæˆæ›´æ–°æ—¥å¿—
          
          ### ğŸ” éªŒè¯é¡¹ç›®
          - [ ] äºŒè¿›åˆ¶æ–‡ä»¶å®Œæ•´æ€§
          - [ ] é…ç½®æ–‡ä»¶å…¼å®¹æ€§
          - [ ] æ¨¡å—æ‰“åŒ…æµ‹è¯•
          
          ---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
        branch: feature/update-singbox-${{ needs.check-singbox-version.outputs.new_version }}
        delete-branch: true

    - name: ğŸ“Š è¾“å‡ºæ›´æ–°ç»“æœ
      run: |
        echo "## ğŸ‰ sing-boxæ›´æ–°å®Œæˆ!"
        echo "**æ–°ç‰ˆæœ¬**: ${{ needs.check-singbox-version.outputs.new_version }}"
        echo "**æ”¯æŒæ¶æ„**: amd64, arm64, armv7"
        echo "**æ›´æ–°æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")"
        echo ""
        echo "### ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "1. æ£€æŸ¥å¹¶åˆå¹¶åˆ›å»ºçš„Pull Request"
        echo "2. æµ‹è¯•æ–°ç‰ˆæœ¬çš„åŠŸèƒ½"
        echo "3. ç­‰å¾…è‡ªåŠ¨æ‰“åŒ…å®Œæˆ"

  notify-failure:
    needs: [check-singbox-version, update-singbox]
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¢ å‘é€å¤±è´¥é€šçŸ¥
      run: |
        echo "âŒ sing-boxè‡ªåŠ¨æ›´æ–°å¤±è´¥"
        echo "**æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")"
        echo "**å·¥ä½œæµ**: ${{ github.workflow }}"
        echo "**è¿è¡ŒID**: ${{ github.run_id }}"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚é‚®ä»¶ã€Slackç­‰
        # ä¾‹å¦‚å‘é€åˆ°Issuesæˆ–Discussion