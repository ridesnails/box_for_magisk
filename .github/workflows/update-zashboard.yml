name: ğŸ¨ Update Zashboard UI

on:
  schedule:
    # æ¯å¤©çš„ 04:00 å’Œ 16:00 UTC æ£€æŸ¥æ›´æ–° (é”™å¼€ä¸sing-boxæ›´æ–°æ—¶é—´)
    - cron: '0 4,16 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      ui_version:
        description: 'æŒ‡å®šUIç‰ˆæœ¬ (ç•™ç©ºä¸ºæœ€æ–°ç‰ˆ)'
        required: false
        default: ''
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  check-zashboard-version:
    runs-on: ubuntu-latest
    outputs:
      should_update: ${{ steps.check.outputs.should_update }}
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
      download_url: ${{ steps.check.outputs.download_url }}
      release_notes: ${{ steps.check.outputs.release_notes }}
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” æ£€æŸ¥Zashboardç‰ˆæœ¬
      id: check
      run: |
        # è·å–å½“å‰UIç‰ˆæœ¬ä¿¡æ¯
        if [ -f "box/zashboard/config.json" ]; then
          current_version=$(jq -r '.zashboard.version // "unknown"' box/zashboard/config.json 2>/dev/null || echo "unknown")
        else
          current_version="unknown"
        fi
        echo "current_version=$current_version" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ å½“å‰Zashboardç‰ˆæœ¬: $current_version"
        
        # æ£€æŸ¥GitHub APIé™åˆ¶
        api_remaining=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/rate_limit" | jq -r '.rate.remaining')
        echo "ğŸ”¥ GitHub APIå‰©ä½™è°ƒç”¨æ¬¡æ•°: $api_remaining"
        
        if [ "$api_remaining" -lt 10 ]; then
          echo "âš ï¸ GitHub APIè°ƒç”¨æ¬¡æ•°ä¸è¶³ï¼Œè·³è¿‡æ­¤æ¬¡æ£€æŸ¥"
          echo "should_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        if [ -n "${{ github.event.inputs.ui_version }}" ]; then
          # ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
          new_version="${{ github.event.inputs.ui_version }}"
          latest_release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/Zephyruso/zashboard/releases/tags/$new_version")
        else
          # è·å–æœ€æ–°ç‰ˆæœ¬
          latest_release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/Zephyruso/zashboard/releases/latest")
          new_version=$(echo "$latest_release" | jq -r '.tag_name')
        fi
        
        release_name=$(echo "$latest_release" | jq -r '.name')
        release_notes=$(echo "$latest_release" | jq -r '.body // "æ— å‘å¸ƒè¯´æ˜"')
        
        echo "ğŸ¯ æœ€æ–°ç‰ˆæœ¬: $new_version"
        echo "ğŸ“ å‘å¸ƒåç§°: $release_name"
        echo "new_version=$new_version" >> $GITHUB_OUTPUT
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        echo "$release_notes" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        should_update=false
        if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          should_update=true
          echo "ğŸ”„ å¼ºåˆ¶æ›´æ–°æ¨¡å¼"
        elif [ "$current_version" != "$new_version" ] && [ "$new_version" != "null" ]; then
          should_update=true
          echo "âœ… å‘ç°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ–°"
        else
          echo "ğŸ“‹ ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
        fi
        
        echo "should_update=$should_update" >> $GITHUB_OUTPUT
        
        # è·å–ä¸‹è½½é“¾æ¥
        if [ "$should_update" = "true" ]; then
          # æŸ¥æ‰¾dist.zipæˆ–ç±»ä¼¼çš„åˆ†å‘æ–‡ä»¶
          download_url=$(echo "$latest_release" | jq -r '.assets[] | 
            select(.name | test("(dist|build|zashboard).*\\.zip$")) | 
            .browser_download_url' | head -1)
          
          # å¦‚æœæ²¡æ‰¾åˆ°zipæ–‡ä»¶ï¼Œä½¿ç”¨tarball
          if [ "$download_url" = "" ] || [ "$download_url" = "null" ]; then
            download_url=$(echo "$latest_release" | jq -r '.tarball_url')
          fi
          
          echo "ğŸ“¦ ä¸‹è½½é“¾æ¥: $download_url"
          echo "download_url=$download_url" >> $GITHUB_OUTPUT
        fi

  update-zashboard:
    needs: check-zashboard-version
    if: needs.check-zashboard-version.outputs.should_update == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âš™ï¸ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: âš™ï¸ è®¾ç½®Gité…ç½®
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: ğŸ¨ ä¸‹è½½å’Œæ›´æ–°Zashboard UI
      run: |
        new_version="${{ needs.check-zashboard-version.outputs.new_version }}"
        download_url="${{ needs.check-zashboard-version.outputs.download_url }}"
        
        echo "ğŸ”„ å¼€å§‹æ›´æ–°Zashboard UIåˆ°ç‰ˆæœ¬: $new_version"
        echo "ğŸ“¦ ä¸‹è½½é“¾æ¥: $download_url"
        
        # åˆ›å»ºä¸´æ—¶ä¸‹è½½ç›®å½•
        mkdir -p temp_ui_download
        cd temp_ui_download
        
        # ä¸‹è½½UIæ–‡ä»¶
        echo "ğŸ“¥ ä¸‹è½½Zashboard UIæ–‡ä»¶..."
        
        if echo "$download_url" | grep -q "\.zip$"; then
          # ä¸‹è½½zipæ–‡ä»¶
          curl -L -f -o "zashboard.zip" "$download_url"
          
          # è§£å‹æ–‡ä»¶
          unzip -q "zashboard.zip"
          
          # æŸ¥æ‰¾distç›®å½•æˆ–æ„å»ºè¾“å‡º
          if [ -d "dist" ]; then
            ui_dir="dist"
          elif [ -d "build" ]; then
            ui_dir="build"
          elif [ -d "public" ]; then
            ui_dir="public"
          else
            # æŸ¥æ‰¾åŒ…å«index.htmlçš„ç›®å½•
            ui_dir=$(find . -name "index.html" -type f | head -1 | xargs dirname)
          fi
        else
          # ä¸‹è½½tarball
          curl -L -f -o "zashboard.tar.gz" "$download_url"
          
          # è§£å‹tarball
          tar -xzf "zashboard.tar.gz"
          
          # æŸ¥æ‰¾ä¸»ç›®å½•
          main_dir=$(find . -maxdepth 1 -type d -name "*zashboard*" | head -1)
          
          if [ -n "$main_dir" ]; then
            cd "$main_dir"
            
            # å°è¯•æ„å»ºé¡¹ç›®
            if [ -f "package.json" ]; then
              echo "ğŸ“¦ å®‰è£…ä¾èµ–å¹¶æ„å»ºé¡¹ç›®..."
              npm install
              
              # å°è¯•ä¸åŒçš„æ„å»ºå‘½ä»¤
              if npm run build >/dev/null 2>&1; then
                echo "âœ… ä½¿ç”¨ npm run build æ„å»ºæˆåŠŸ"
              elif npm run dist >/dev/null 2>&1; then
                echo "âœ… ä½¿ç”¨ npm run dist æ„å»ºæˆåŠŸ"
              else
                echo "âš ï¸ æ— æ³•è‡ªåŠ¨æ„å»ºï¼Œä½¿ç”¨æºæ–‡ä»¶"
              fi
            fi
            
            # æŸ¥æ‰¾æ„å»ºè¾“å‡ºç›®å½•
            if [ -d "dist" ]; then
              ui_dir="dist"
            elif [ -d "build" ]; then
              ui_dir="build"
            elif [ -d "public" ]; then
              ui_dir="public"
            else
              ui_dir="."
            fi
          else
            echo "âŒ æ— æ³•æ‰¾åˆ°ä¸»ç›®å½•"
            exit 1
          fi
        fi
        
        echo "ğŸ“ UIç›®å½•: $ui_dir"
        
        if [ ! -d "$ui_dir" ] || [ ! -f "$ui_dir/index.html" ]; then
          echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„UIæ–‡ä»¶"
          exit 1
        fi
        
        # å¤‡ä»½ç°æœ‰webroot
        cd ..
        if [ -d "webroot" ]; then
          cp -r webroot webroot_backup
          echo "ğŸ’¾ å·²å¤‡ä»½ç°æœ‰webroot"
        fi
        
        # æ¸…ç†å¹¶å¤åˆ¶æ–°çš„UIæ–‡ä»¶
        rm -rf webroot/*
        cp -r "temp_ui_download/$ui_dir"/* webroot/
        
        echo "âœ… UIæ–‡ä»¶å·²æ›´æ–°"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf temp_ui_download

    - name: ğŸ”§ é…ç½®Zashboard
      run: |
        new_version="${{ needs.check-zashboard-version.outputs.new_version }}"
        current_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # æ›´æ–°zashboardé…ç½®æ–‡ä»¶
        jq -n \
          --arg version "$new_version" \
          --arg updated_at "$current_date" \
          '{
            "version": $version,
            "updated_at": $updated_at,
            "source": "https://github.com/Zephyruso/zashboard",
            "api_endpoint": "http://127.0.0.1:9090",
            "features": {
              "auto_update": true,
              "dark_mode": true,
              "connection_stats": true
            },
            "ui_path": "/data/adb/box/webroot"
          }' > box/zashboard/config.json
        
        # æ£€æŸ¥webrootä¸­æ˜¯å¦æœ‰é…ç½®æ–‡ä»¶éœ€è¦æ›´æ–°
        if [ -f "webroot/config.js" ]; then
          # æ›´æ–°APIç«¯ç‚¹é…ç½®
          sed -i 's/localhost:9090/127.0.0.1:9090/g' webroot/config.js
          echo "âœ… å·²æ›´æ–°APIç«¯ç‚¹é…ç½®"
        fi
        
        # ç¡®ä¿æƒé™æ­£ç¡®
        find webroot -type f -exec chmod 644 {} \;
        find webroot -type d -exec chmod 755 {} \;
        
        echo "âœ… Zashboardé…ç½®å®Œæˆ"

    - name: ğŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—
      run: |
        new_version="${{ needs.check-zashboard-version.outputs.new_version }}"
        current_version="${{ needs.check-zashboard-version.outputs.current_version }}"
        current_date=$(date +"%Y-%m-%d")
        current_time=$(date +"%Y-%m-%d %H:%M:%S UTC")
        release_notes="${{ needs.check-zashboard-version.outputs.release_notes }}"
        
        # åˆ›å»ºæ›´æ–°æ—¥å¿—æ¡ç›®
        {
          echo ""
          echo "## [UI-$new_version] - $current_date"
          echo ""
          echo "### ğŸ¨ Zashboard UIæ›´æ–°"
          echo "- æ›´æ–°ç‰ˆæœ¬: $current_version â†’ $new_version"
          echo "- æ›´æ–°æ—¶é—´: $current_time"
          echo "- æ›´æ–°æ–¹å¼: è‡ªåŠ¨æ›´æ–°"
          echo ""
          echo "### ğŸ“‹ Zashboardå‘å¸ƒè¯´æ˜"
          echo "$release_notes"
          echo ""
          echo "### ğŸ› ï¸ æ›´æ–°å†…å®¹"
          echo "- æ›´æ–°Webç•Œé¢æ–‡ä»¶"
          echo "- æ›´æ–°é…ç½®æ–‡ä»¶"
          echo "- ä¼˜åŒ–APIç«¯ç‚¹é…ç½®"
          echo ""
        } >> CHANGELOG.md

    - name: ğŸ” éªŒè¯æ›´æ–°
      run: |
        # æ£€æŸ¥webrootç›®å½•
        if [ -d "webroot" ] && [ -f "webroot/index.html" ]; then
          echo "âœ… webrootç›®å½•å’Œindex.htmlå­˜åœ¨"
          file_count=$(find webroot -type f | wc -l)
          echo "   æ–‡ä»¶æ€»æ•°: $file_count"
        else
          echo "âŒ webrootç›®å½•æˆ–index.htmlç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if [ -f "box/zashboard/config.json" ]; then
          echo "âœ… zashboardé…ç½®æ–‡ä»¶å·²æ›´æ–°:"
          cat box/zashboard/config.json | jq .
        else
          echo "âŒ zashboardé…ç½®æ–‡ä»¶ç¼ºå¤±"
        fi
        
        # æ£€æŸ¥å¸¸è§UIæ–‡ä»¶
        ui_files=("index.html" "assets" "js" "css")
        for file in "${ui_files[@]}"; do
          if [ -e "webroot/$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âš ï¸ $file ä¸å­˜åœ¨"
          fi
        done

    - name: ğŸ“¤ æäº¤å˜æ›´
      run: |
        new_version="${{ needs.check-zashboard-version.outputs.new_version }}"
        current_time=$(date +"%Y-%m-%d %H:%M:%S UTC")
        
        git add .
        
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ¨ è‡ªåŠ¨æ›´æ–°Zashboard UIåˆ° $new_version" \
                     -m "- æ›´æ–°Zashboard UIåˆ°ç‰ˆæœ¬ $new_version" \
                     -m "- æ›´æ–°Webç•Œé¢æ–‡ä»¶å’Œé…ç½®" \
                     -m "- ä¼˜åŒ–APIç«¯ç‚¹é…ç½®" \
                     -m "- æ›´æ–°æ—¶é—´: $current_time" \
                     -m "" \
                     -m "Co-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          
          echo "âœ… å˜æ›´å·²æäº¤"
        else
          echo "ğŸ“‹ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
        fi

    - name: ğŸš€ åˆ›å»ºPull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ¨ è‡ªåŠ¨æ›´æ–°Zashboard UIåˆ° ${{ needs.check-zashboard-version.outputs.new_version }}"
        title: "ğŸ¨ è‡ªåŠ¨æ›´æ–°Zashboard UIåˆ° ${{ needs.check-zashboard-version.outputs.new_version }}"
        body: |
          ## ğŸ¨ Zashboard UIè‡ªåŠ¨æ›´æ–°
          
          **å½“å‰ç‰ˆæœ¬**: `${{ needs.check-zashboard-version.outputs.current_version }}`
          **æ–°ç‰ˆæœ¬**: `${{ needs.check-zashboard-version.outputs.new_version }}`
          **æ›´æ–°æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          - âœ… æ›´æ–°Zashboard Webç•Œé¢
          - âœ… æ›´æ–°UIé…ç½®æ–‡ä»¶
          - âœ… ä¼˜åŒ–APIç«¯ç‚¹é…ç½®
          - âœ… ä¿æŒé…ç½®å…¼å®¹æ€§
          
          ### ğŸ” éªŒè¯é¡¹ç›®
          - [ ] Webç•Œé¢åŠŸèƒ½æµ‹è¯•
          - [ ] APIè¿æ¥æµ‹è¯•
          - [ ] å“åº”å¼å¸ƒå±€æµ‹è¯•
          - [ ] æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
          
          ### ğŸ“‹ Zashboardå‘å¸ƒè¯´æ˜
          ${{ needs.check-zashboard-version.outputs.release_notes }}
          
          ---
          *æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
        branch: feature/update-zashboard-${{ needs.check-zashboard-version.outputs.new_version }}
        delete-branch: true

    - name: ğŸ”™ å›æ»šæœºåˆ¶
      if: failure()
      run: |
        echo "âŒ æ›´æ–°å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
        
        if [ -d "webroot_backup" ]; then
          rm -rf webroot
          mv webroot_backup webroot
          echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰çš„UIç‰ˆæœ¬"
        else
          echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½ï¼Œæ— æ³•å›æ»š"
        fi

    - name: ğŸ“Š è¾“å‡ºæ›´æ–°ç»“æœ
      run: |
        echo "## ğŸ‰ Zashboard UIæ›´æ–°å®Œæˆ!"
        echo "**æ–°ç‰ˆæœ¬**: ${{ needs.check-zashboard-version.outputs.new_version }}"
        echo "**æ›´æ–°æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")"
        echo ""
        echo "### ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "1. æ£€æŸ¥å¹¶åˆå¹¶åˆ›å»ºçš„Pull Request"
        echo "2. æµ‹è¯•Webç•Œé¢åŠŸèƒ½"
        echo "3. éªŒè¯APIè¿æ¥æ­£å¸¸"

  notify-failure:
    needs: [check-zashboard-version, update-zashboard]
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¢ å‘é€å¤±è´¥é€šçŸ¥
      run: |
        echo "âŒ Zashboard UIè‡ªåŠ¨æ›´æ–°å¤±è´¥"
        echo "**æ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S UTC")"
        echo "**å·¥ä½œæµ**: ${{ github.workflow }}"
        echo "**è¿è¡ŒID**: ${{ github.run_id }}"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚é‚®ä»¶ã€Slackç­‰